# ======================================================================
# SERVIDOR HTTPS AUTO-ASSINADO (Porta 443)
# ======================================================================

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    # O 'server_name' pode ser o IP ou apenas um placeholder
    server_name 10.0.12.3;

    # --- Configuração SSL Auto-assinado (da Etapa 1) ---
    ssl_certificate /etc/ssl/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/ssl/private/nginx-selfsigned.key;

    # Protocolos de segurança
    ssl_protocols TLSv1.2 TLSv1.3;

    # ======================================================================
    # <<< CONFIGURAÇÃO DO DIRETÓRIO PROTEGIDO >>>
    # ======================================================================

    # Define a raiz (root) do servidor como /var/www
    # Isso é importante. O Nginx vai mapear o URL para este diretório.
    # Ex: URL /spawn/VM/arquivo -> /var/www/spawn/VM/arquivo
    root /var/www;

    # Localização para TODO o diretório /spawn/
    location /spawn/ {

        # 1. Defina seu token (hash) secreto aqui
        set $secret_key "15d5d0956bc57ab33186c10a3fd78c840d3cbbac6dc68853ce1c6726253ce6d5";

        # 2. Verifica se o argumento 'token' na URL NÃO é igual à sua chave
        if ($arg_token != $secret_key) {
            # Se for diferente ou não existir, retorna 403 (Proibido)
            return 403;
        }

        # 3. (MUITO ÚTIL) Ativa a listagem de diretórios
        # Se o usuário acessar https://.../spawn/?token=...
        # ele verá uma lista de arquivos e pastas, como no Apache.
        autoindex on;

        # 4. Tenta servir o arquivo ou diretório solicitado
        # Se não encontrar, retorna 404.
        try_files $uri $uri/ =404;
    }

    # (Opcional) Responde a qualquer outra requisição com 404 (Não Encontrado)
    # Isso impede que acessem /html ou outros diretórios em /var/www
    location / {
        return 404;
    }
}