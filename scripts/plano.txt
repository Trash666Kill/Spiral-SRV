Ele usa um arquivo de **Manifesto** como "banco de dados" para rastrear o ciclo ativo e garante que os backups completos consolidados (`Full-Merged`) sejam intoc치veis.

---

## 1. Argumento de Controle Requerido 丘뙖잺

O 칰nico par칙metro de controle para a l칩gica do ciclo de vida 칠:

| Argumento | Fun칞칚o | Padr칚o |
| :--- | :--- | :--- |
| **`--max-incrementals`** | Define o n칰mero de backups incrementais que o script criar치 antes de for칞ar uma Consolida칞칚o (Merge). | **7** |

---

## 2. O "Banco de Dados" (Manifesto) e Valida칞칚o por Hash 游댏

Em vez de um banco de dados SQL, o script usa um arquivo `manifest.json` no diret칩rio de backup da VM para rastrear o **ciclo ativo** e garantir a integridade da "fam칤lia" (cadeia):

* **Valida칞칚o da Fam칤lia:** O Manifesto armazenar치 o **Hash SHA-256** do arquivo **Base (Full)**. A cada execu칞칚o incremental, o script recalcula o hash do arquivo Base f칤sico e o compara com o valor armazenado no Manifesto. Se os hashes n칚o coincidirem, o ciclo 칠 abortado por comprometimento de integridade.
* **Conte칰do do Manifesto:**
    * `status: "active"`
    * `base_full_file`: Caminho do arquivo Base.
    * **`base_full_hash_sha256`**: **O Hash da Fam칤lia.**
    * `last_checkpoint_name`: Nome do 칰ltimo checkpoint `libvirt` criado.
    * `incremental_files`: Lista dos arquivos incrementais gerados at칠 agora.

---

## 3. Fluxo de Execu칞칚o (L칩gica Autom치tica)

O script decide automaticamente entre Full (Base), Incremental ou Consolida칞칚o a cada execu칞칚o.

### Etapa Zero: Verifica칞칚o Inicial

1.  O script procura por um `manifest.json` com `status: "active"`.

### Cen치rio A: In칤cio de um Novo Ciclo (Full Base)

* **Gatilho:** Nenhum `manifest.json` ativo encontrado.
* **A칞칚o:**
    1.  Executar um **Backup Completo (Base)** com `dom.backupBegin()`.
    2.  Calcular o **Hash SHA-256** do novo arquivo Base.
    3.  Criar um novo **checkpoint `libvirt`** para marcar o ponto de partida do ciclo.
    4.  Criar o `manifest.json` e registrar o Base e o **Hash da Fam칤lia**.

---

### Cen치rio B: Execu칞칚o Incremental

* **Gatilho:** Manifesto ativo encontrado e `Contagem de Incrementais < --max-incrementals`.
* **A칞칚o:**
    1.  **Valida칞칚o por Hash (Check de Integridade):** Recalcular o hash do arquivo Base f칤sico e compar치-lo com o `base_full_hash_sha256` do Manifesto.
        * Se **diferente**, abortar com erro (integridade comprometida).
        * Se **igual**, prosseguir.
    2.  Executar um **Backup Incremental** usando o `last_checkpoint_name` do Manifesto.
    3.  **P칩s-Sucesso:**
        * Criar um **novo checkpoint `libvirt`**.
        * Atualizar o Manifesto com o novo arquivo e o novo checkpoint.
        * **Excluir o checkpoint `libvirt` anterior**, mantendo apenas o mais recente como refer칡ncia de partida para o pr칩ximo backup.

---

### Cen치rio C: Fim do Ciclo (Consolida칞칚o)

* **Gatilho:** Manifesto ativo encontrado e `Contagem de Incrementais >= --max-incrementals`.
* **A칞칚o:**
    1.  **Consolida칞칚o (Merge):**
        * Gerar um nome de arquivo **칰nico** para o backup consolidado (ex: `VM-Full-Merged-YYYYMMDD_HHMMSS.qcow2`).
        * Executar o comando externo (ex: `qemu-img convert`) para mesclar a cadeia completa de arquivos (Base + todos os Incrementais) no novo arquivo `Full-Merged...`.
    2.  **Limpeza do Ciclo (Garantia de Substitui칞칚o Zero):**
        * **Remover a Cadeia Ativa Tempor치ria:** Excluir o `manifest.json`.
        * **Remover Arquivos Tempor치rios:** Excluir o arquivo Base e todos os arquivos Incrementais.
        * **Remover Checkpoint:** Excluir o *칰ltimo* checkpoint `libvirt` que estava ativo.

---

### Resultado da Reten칞칚o

O script **nunca ir치 remover** nenhum arquivo com o prefixo `Full-Merged`. Eles ser칚o tratados como produtos finais permanentes. O diret칩rio de backup passar치 a conter:

1.  Os arquivos **`Full-Merged-*.qcow2`** (acumulando-se ao longo do tempo).
2.  Ou a cadeia tempor치ria (`Base + Incrementais` + `manifest.json`) se um ciclo estiver ativo.