√â um prazer! O plano final de implementa√ß√£o √© um sistema robusto de backups incrementais com **consolida√ß√£o e valida√ß√£o de integridade por Hash**.

Ele usa um arquivo de **Manifesto** como "banco de dados" para rastrear o ciclo ativo e garante que os backups completos consolidados (`Full-Merged`) sejam intoc√°veis.

---

## 1. Argumento de Controle Requerido ‚öôÔ∏è

O √∫nico par√¢metro de controle para a l√≥gica do ciclo de vida √©:

| Argumento | Fun√ß√£o | Padr√£o |
| :--- | :--- | :--- |
| **`--max-incrementals`** | Define o n√∫mero de backups incrementais que o script criar√° antes de for√ßar uma Consolida√ß√£o (Merge). | **7** |

---

## 2. O "Banco de Dados" (Manifesto) e Valida√ß√£o por Hash üîê

Em vez de um banco de dados SQL, o script usa um arquivo `manifest.json` no diret√≥rio de backup da VM para rastrear o **ciclo ativo** e garantir a integridade da "fam√≠lia" (cadeia):

* **Valida√ß√£o da Fam√≠lia:** O Manifesto armazenar√° o **Hash SHA-256** do arquivo **Base (Full)**. A cada execu√ß√£o incremental, o script recalcula o hash do arquivo Base f√≠sico e o compara com o valor armazenado no Manifesto. Se os hashes n√£o coincidirem, o ciclo √© abortado por comprometimento de integridade.
* **Conte√∫do do Manifesto:**
    * `status: "active"`
    * `base_full_file`: Caminho do arquivo Base.
    * **`base_full_hash_sha256`**: **O Hash da Fam√≠lia.**
    * `last_checkpoint_name`: Nome do √∫ltimo checkpoint `libvirt` criado.
    * `incremental_files`: Lista dos arquivos incrementais gerados at√© agora.

---

## 3. Fluxo de Execu√ß√£o (L√≥gica Autom√°tica)

O script decide automaticamente entre Full (Base), Incremental ou Consolida√ß√£o a cada execu√ß√£o.

### Etapa Zero: Verifica√ß√£o Inicial

1.  O script procura por um `manifest.json` com `status: "active"`.

### Cen√°rio A: In√≠cio de um Novo Ciclo (Full Base)

* **Gatilho:** Nenhum `manifest.json` ativo encontrado.
* **A√ß√£o:**
    1.  Executar um **Backup Completo (Base)** com `dom.backupBegin()`.
    2.  Calcular o **Hash SHA-256** do novo arquivo Base.
    3.  Criar um novo **checkpoint `libvirt`** para marcar o ponto de partida do ciclo.
    4.  Criar o `manifest.json` e registrar o Base e o **Hash da Fam√≠lia**.

---

### Cen√°rio B: Execu√ß√£o Incremental

* **Gatilho:** Manifesto ativo encontrado e `Contagem de Incrementais < --max-incrementals`.
* **A√ß√£o:**
    1.  **Valida√ß√£o por Hash (Check de Integridade):** Recalcular o hash do arquivo Base f√≠sico e compar√°-lo com o `base_full_hash_sha256` do Manifesto.
        * Se **diferente**, abortar com erro (integridade comprometida).
        * Se **igual**, prosseguir.
    2.  Executar um **Backup Incremental** usando o `last_checkpoint_name` do Manifesto.
    3.  **P√≥s-Sucesso:**
        * Criar um **novo checkpoint `libvirt`**.
        * Atualizar o Manifesto com o novo arquivo e o novo checkpoint.
        * **Excluir o checkpoint `libvirt` anterior**, mantendo apenas o mais recente como refer√™ncia de partida para o pr√≥ximo backup.

---

### Cen√°rio C: Fim do Ciclo (Consolida√ß√£o)

* **Gatilho:** Manifesto ativo encontrado e `Contagem de Incrementais >= --max-incrementals`.
* **A√ß√£o:**
    1.  **Consolida√ß√£o (Merge):**
        * Gerar um nome de arquivo **√∫nico** para o backup consolidado (ex: `VM-Full-Merged-YYYYMMDD_HHMMSS.qcow2`).
        * Executar o comando externo (ex: `qemu-img convert`) para mesclar a cadeia completa de arquivos (Base + todos os Incrementais) no novo arquivo `Full-Merged...`.
    2.  **Limpeza do Ciclo (Garantia de Substitui√ß√£o Zero):**
        * **Remover a Cadeia Ativa Tempor√°ria:** Excluir o `manifest.json`.
        * **Remover Arquivos Tempor√°rios:** Excluir o arquivo Base e todos os arquivos Incrementais.
        * **Remover Checkpoint:** Excluir o *√∫ltimo* checkpoint `libvirt` que estava ativo.

---

### Resultado da Reten√ß√£o

O script **nunca ir√° remover** nenhum arquivo com o prefixo `Full-Merged`. Eles ser√£o tratados como produtos finais permanentes. O diret√≥rio de backup passar√° a conter:

1.  Os arquivos **`Full-Merged-*.qcow2`** (acumulando-se ao longo do tempo).
2.  Ou a cadeia tempor√°ria (`Base + Incrementais` + `manifest.json`) se um ciclo estiver ativo.